name: Deployment Status\non:\n  push:\n    branches: [ main ]\n\njobs:\n  pre-deployment:\n    runs-on: ubuntu-latest\n    outputs:\n      issue_number: ${{ steps.create-issue.outputs.issue_number }}\n      previous_sha: ${{ steps.get-prev-sha.outputs.previous_sha }}\n      package_version: ${{ steps.get-package-version.outputs.package_version }}\n    steps:\n      - name: Checkout code\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 2\n\n      - name: Set up Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n\n      - name: Install dependencies\n        run: npm ci\n\n      - name: Lint code\n        run: npm run lint\n\n      - name: Run tests\n        run: npm test\n\n      - name: Get previous commit SHA\n        id: get-prev-sha\n        run: echo \"previous_sha=$(git rev-parse HEAD^1)\" >> $GITHUB_OUTPUT\n\n      - name: Get package version\n        id: get-package-version\n        run: echo \"package_version=$(npm pkg get version | tr -d '\\\"')\" >> $GITHUB_OUTPUT\n\n      - name: Create deployment issue\n        id: create-issue\n        uses: actions/github-script@v7\n        with:\n          script: |\n            const issue = await github.rest.issues.create({\n              owner: context.repo.owner,\n              repo: context.repo.repo,\n              title: `Deployment Tracking - ${context.sha}`,\n              labels: ['deployment', 'in-progress'],\n              body: `Pre-deployment checks in progress...`\n            });\n            core.setOutput('issue_number', issue.data.number);\n\n      - name: Post pre-deployment comment\n        uses: actions/github-script@v7\n        with:\n          script: |\n            await github.rest.issues.createComment({\n              owner: context.repo.owner,\n              repo: context.repo.repo,\n              issue_number: ${{ steps.create-issue.outputs.issue_number }},\n              body: `Pre-deployment checks completed`\n            });\n\n  rollback-preparation:\n    runs-on: ubuntu-latest\n    needs: pre-deployment\n    outputs:\n      artifact_name: ${{ steps.create-artifact.outputs.artifact_name }}\n      artifact_checksum: ${{ steps.compute-checksum.outputs.checksum }}\n    steps:\n      - name: Checkout code\n        uses: actions/checkout@v4\n\n      - name: Set up Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n\n      - name: Create rollback script\n        run: |\n          cat > rollback.sh << 'EOF'\n          #!/bin/bash\n          set -euo pipefail\n\n          echo \"Starting rollback to previous commit: ${{ needs.pre-deployment.outputs.previous_sha }}\"\n\n          git checkout ${{ needs.pre-deployment.outputs.previous_sha }} || { echo \"Failed to checkout previous commit\"; exit 1; }\n          cp backups/package.json .\n          cp backups/package-lock.json .\n          npm ci || { echo \"Failed to install dependencies\"; exit 1; }\n          echo \"Rollback completed successfully. Current commit: $(git rev-parse HEAD)\"\n          EOF\n          chmod +x rollback.sh\n\n      - name: Create configuration backups\n        run: |\n          mkdir -p backups\n          cp package.json backups/\n          cp package-lock.json backups/\n\n      - name: Create dependency verification script\n        run: |\n          cat > verify-dependencies.sh << 'EOF'\n          #!/bin/bash\n          set -euo pipefail\n\n          echo \"Verifying dependency compatibility with previous commit...\"\n          diff package-lock.json backups/package-lock.json || {\n            echo \"Dependency mismatch detected. Rollback may be required.\"\n            exit 1\n          }\n          echo \"Dependencies verified successfully.\"\n          EOF\n          chmod +x verify-dependencies.sh\n\n      - name: Create rollback documentation\n        run: |\n          cat > rollback-docs.md << 'EOF'\n          # Rollback Instructions\n          1. Download rollback artifact from GitHub Actions\n          2. Extract with: unzip rollback-package-*.zip\n          3. Run: ./rollback.sh\n          4. Verify with: git rev-parse HEAD\n          EOF\n\n      - name: Create rollback package\n        id: create-artifact\n        run: |\n          ARTIFACT_NAME=\"rollback-package-${{ github.sha }}\"\n          zip -r \"${ARTIFACT_NAME}.zip\" rollback.sh backups/ verify-dependencies.sh rollback-docs.md\n          echo \"artifact_name=${ARTIFACT_NAME}\" >> $GITHUB_OUTPUT\n\n      - name: Compute SHA256 checksum\n        id: compute-checksum\n        run: |\n          CHECKSUM=$(sha256sum \"${{ steps.create-artifact.outputs.artifact_name }}.zip\" | awk '{print $1}')\n          echo \"checksum=${CHECKSUM}\" >> $GITHUB_OUTPUT\n\n      - name: Upload rollback artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: ${{ steps.create-artifact.outputs.artifact_name }}\n          path: ${{ steps.create-artifact.outputs.artifact_name }}.zip\n          retention-days: 30\n\n      - name: Post rollback comment\n        uses: actions/github-script@v7\n        with:\n          script: |\n            const body = `## ðŸ”„ Rollback Plan Ready\n- Previous Commit: ${{ needs.pre-deployment.outputs.previous_sha }}\n- Current Commit: ${{ github.sha }}\n- Package Version: ${{ needs.pre-deployment.outputs.package_version }}\n- Artifact: ${{ steps.create-artifact.outputs.artifact_name }}\n- âœ… Rollback script created\n- âœ… Configuration backups completed\n- âœ… Dependency verification script created\n- âœ… Rollback documentation written\n- âœ… Rollback package compressed\n- SHA256: ${{ steps.compute-checksum.outputs.checksum }}\n\n### Quick Rollback Command\n\`\`\`bash\ngh run download ${{ github.run_id }} --name ${{ steps.create-artifact.outputs.artifact_name }}\nunzip ${{ steps.create-artifact.outputs.artifact_name }}.zip\n./rollback.sh\n\`\`\`\n\n- Rollback script created: true\n- Configuration backup: true`;\n            await github.rest.issues.createComment({\n              owner: context.repo.owner,\n              repo: context.repo.repo,\n              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},\n              body: body\n            });\n\n  post-deployment:\n    runs-on: ubuntu-latest\n    needs: rollback-preparation\n    steps:\n      - name: Update issue labels\n        uses: actions/github-script@v7\n        with:\n          script: |\n            await github.rest.issues.removeLabel({\n              owner: context.repo.owner,\n              repo: context.repo.repo,\n              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},\n              name: 'in-progress'\n            });\n            await github.rest.issues.addLabels({\n              owner: context.repo.owner,\n              repo: context.repo.repo,\n              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},\n              labels: ['completed']\n            });\n\n      - name: Post final comment\n        uses: actions/github-script@v7\n        with:\n          script: |\n            await github.rest.issues.createComment({\n              owner: context.repo.owner,\n              repo: context.repo.repo,\n              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},\n              body: `Deployment Completed Successfully`\n            });\n\n      - name: Close deployment issue\n        uses: actions/github-script@v7\n        with:\n          script: |\n            await github.rest.issues.update({\n              owner: context.repo.owner,\n              repo: context.repo.repo,\n              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},\n              state: 'closed'\n            });